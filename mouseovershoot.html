<!doctype html>
<html>
<head>
    <script src="js/phaser.min.js"></script>
    <style type="text/css">
        canvas {border: 0;}
    </style>
</head>
<body>
<script>
    var TILE = 64;
    var HTILE = TILE/2;
    var ROWS = 8;
    var COLS = 12;
    var bg, grid;
    var player, enemy, cursors, bullets;
    var moveTarget = {x: 0, y: 0};
    var game = new Phaser.Game(COLS * TILE, ROWS * TILE, Phaser.AUTO, '', {preload: preload, create: create, update: update});
    
    function preload() {
        game.load.spritesheet('lizardAppear','assets/deimaginator_appear.png', 251, 186, 25);
        game.load.spritesheet('lizardIdle','assets/deimaginator_idle.png', 251, 186, 135);
        game.load.spritesheet('robotAppear','assets/robot_attract.png', 81, 88, 57);
        game.load.spritesheet('robotIdle','assets/robot_idle.png', 81, 88, 24);
        game.load.spritesheet('catFly', 'assets/cat_fly.png', 136, 115, 20);
        game.load.image('bullet', 'assets/bullet.png');
    }
    //-------------------
    function create() {
        // init physics
        game.physics.startSystem(Phaser.Physics.ARCADE);
        
        //init bg
        bg = game.add.graphics(0, 0);
        bg.beginFill(0xffffff);
        bg.drawRect(0, 0, game.world.width, game.world.height);
        bg.endFill();
        grid = game.add.graphics(0, 0);
        grid.lineStyle(1, 0x999999);
        for (var i=0; i < COLS; i++){
            grid.moveTo(i*TILE, 0);
            grid.lineTo(i*TILE, game.world.height);
        }
        for (var i=0; i < ROWS; i++){
            grid.moveTo(0, i*TILE);
            grid.lineTo(game.world.width, i*TILE);
        }
        
        //init enemy
        enemy = game.add.sprite((6 * TILE) + HTILE, (6 * TILE) + HTILE, 'robotAppear');
        enemy.anchor.x = 0.5;
        enemy.anchor.y = 0.7;
        enemy.inputEnabled = true;
        enemy.underAim = false;
        enemy.animations.add('appear');
        enemy.events.onAnimationComplete.add(appearComplete, this);
        enemy.events.onInputOver.add(enemyHighlight, this);
        enemy.events.onInputOut.add(enemyTintReset, this);
        enemy.animations.play('appear', 20);
        
        
        //init player
        player = game.add.sprite((3*TILE)+HTILE, 3*TILE, 'catFly');
        player.anchor.x = 0.65;
        player.anchor.y = 0.4;
        player.animations.add('fly');
        player.animations.play('fly', 20, true);
        player.canMove = false;
        
        //init bullets
        
        
        //init inputs
        cursors = game.input.keyboard.createCursorKeys();
        game.input.onDown.add(checkMovePlayer, this);
    }
    //-------------------
    function update() {
        if (player.canMove){
            player.canMove = false;
            movePlayer(moveTarget.x, moveTarget.y);
        }
        
        // player always faces enemy
        if (player.x > enemy.x) {
            player.scale.x = -1;
            enemy.scale.x = -1;
        }
        else {
            player.scale.x = 1;
            enemy.scale.x = 1;
        }
    }
    //------------------
    function appearComplete(){
        enemy.events.onAnimationComplete.remove(appearComplete, this);
        enemy.loadTexture('robotIdle');
        enemy.animations.add('idle');
        enemy.animations.play('idle', 20, true);
    }
    //-----------------
    function checkMovePlayer(pointer){
        if (!player.canMove && !enemy.underAim){
            player.canMove = true;
            moveTarget.x = Math.floor(pointer.x/TILE);
            moveTarget.y = Math.floor(pointer.y/TILE);
        }
    }
    
    function movePlayer(x, y){
        player.x = (x * TILE) + HTILE;
        player.y = (y * TILE);
    }
    //-----------------
    function rndInt(min, max){
        return Math.round(min + (Math.random() * (max-min)));
    }
    //----------------
    function enemyHighlight(pointer){
        enemy.tint = 0xff0000;
        enemy.underAim = true;
    }
    function enemyTintReset(pointer){
        enemy.tint = 0xffffff;
        enemy.underAim = false;
    }

</script>
</body>
</html>