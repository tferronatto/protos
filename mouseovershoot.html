<!doctype html>
<html>
<head>
    <script src="js/phaser.min.js"></script>
    <style type="text/css">
        canvas {border: 0;}
    </style>
</head>
<body>
<script>
    var TILE = 32;
    var HTILE = TILE/2;
    var ROWS = 20;
    var COLS = 20;
    var bg, grid;
    var player, enemy, cursors;
    var moveTarget = {x: 0, y: 0};
    var game = new Phaser.Game(COLS * TILE, ROWS * TILE, Phaser.AUTO, '', {preload: preload, create: create, update: update});
    
    function preload() {
        game.load.spritesheet('lizardAppear','assets/deimaginator_appear.png', 251, 186, 25);
        game.load.spritesheet('lizardIdle','assets/deimaginator_idle.png', 251, 186, 135);
        game.load.spritesheet('catFly', 'assets/cat_fly.png', 136, 115, 20);
    }
    //-------------------
    function create() {
        // init physics
        game.physics.startSystem(Phaser.Physics.ARCADE);
        
        //init bg
        bg = game.add.graphics(0, 0);
        bg.beginFill(0xffffff);
        bg.drawRect(0, 0, game.world.width, game.world.height);
        bg.endFill();
        grid = game.add.graphics(0, 0);
        grid.lineStyle(1, 0x424242);
        for (var i=0; i < COLS; i++){
            grid.moveTo(i*TILE, 0);
            grid.lineTo(i*TILE, game.world.height);
        }
        for (var i=0; i < ROWS; i++){
            grid.moveTo(0, i*TILE);
            grid.lineTo(game.world.width, i*TILE);
        }
        
        //init enemy
        enemy = game.add.sprite(rndInt(0, game.world.width - 251), rndInt(0, game.world.height - 186), 'lizardAppear');
        enemy.inputEnabled = true;
        enemy.underAim = false;
        enemy.animations.add('appear');
        enemy.events.onAnimationComplete.add(appearComplete, this);
        enemy.events.onInputOver.add(enemyHighlight, this);
        enemy.events.onInputOut.add(enemyTintReset, this);
        enemy.animations.play('appear', 20);
        
        
        //init player
        player = game.add.sprite(HTILE, HTILE, 'catFly');
        player.anchor.x = player.anchor.y = 0.5;
        player.animations.add('fly');
        player.animations.play('fly', 20, true);
        player.canMove = false;
        
        //init inputs
        cursors = game.input.keyboard.createCursorKeys();
        game.input.onDown.add(checkMovePlayer, this);
    }
    //-------------------
    function update() {
        if (player.canMove){
            player.canMove = false;
            movePlayer(moveTarget.x, moveTarget.y);
        }
    }
    //------------------
    function appearComplete(){
        enemy.events.onAnimationComplete.remove(appearComplete, this);
        enemy.loadTexture('lizardIdle');
        enemy.animations.add('idle');
        enemy.animations.play('idle', 20, true);
    }
    //-----------------
    function checkMovePlayer(pointer){
        if (!player.canMove && !enemy.underAim){
            player.canMove = true;
            moveTarget.x = Math.floor(pointer.x/TILE);
            moveTarget.y = Math.floor(pointer.y/TILE);
        }
    }
    
    function movePlayer(x, y){
        player.x = (x * TILE) + HTILE;
        player.y = (y * TILE) + HTILE;
    }
    //-----------------
    function rndInt(min, max){
        return Math.round(min + (Math.random() * (max-min)));
    }
    //----------------
    function enemyHighlight(pointer){
        enemy.tint = 0xff0000;
        enemy.underAim = true;
    }
    function enemyTintReset(pointer){
        enemy.tint = 0xffffff;
        enemy.underAim = false;
    }

</script>
</body>
</html>